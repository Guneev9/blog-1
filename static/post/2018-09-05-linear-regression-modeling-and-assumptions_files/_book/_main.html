<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Linear regression: Modeling and Assumptions</title>
  <meta name="description" content="Linear regression: Modeling and Assumptions">
  <meta name="generator" content="bookdown 0.7 and GitBook 2.6.7">

  <meta property="og:title" content="Linear regression: Modeling and Assumptions" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Linear regression: Modeling and Assumptions" />
  
  
  

<meta name="author" content="Kumar Rohit Malhotra">


<meta name="date" content="2018-09-09">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  


<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="0.1" data-path=""><a href="#is-there-a-relationship-between-the-medical-charges-and-the-predictors"><i class="fa fa-check"></i><b>0.1</b> <strong>Is there a relationship between the medical charges and the predictors?</strong></a></li>
<li class="chapter" data-level="0.2" data-path=""><a href="#which-variables-have-a-strong-relation-to-medical-charges"><i class="fa fa-check"></i><b>0.2</b> <strong>Which variables have a strong relation to medical charges?</strong></a></li>
<li class="chapter" data-level="0.3" data-path=""><a href="#are-there-any-multicollinear-features"><i class="fa fa-check"></i><b>0.3</b> <strong>Are there any multicollinear features?</strong></a></li>
<li class="chapter" data-level="0.4" data-path=""><a href="#is-the-relationship-linear"><i class="fa fa-check"></i><b>0.4</b> <strong>Is the relationship linear?</strong></a></li>
<li class="chapter" data-level="0.5" data-path=""><a href="#non-constant-variance-of-error-terms"><i class="fa fa-check"></i><b>0.5</b> <strong>Non-constant variance of error terms</strong></a></li>
<li class="chapter" data-level="0.6" data-path=""><a href="#correlation-of-error-terms"><i class="fa fa-check"></i><b>0.6</b> <strong>Correlation of error terms</strong></a></li>
<li class="chapter" data-level="0.7" data-path=""><a href="#interpretations"><i class="fa fa-check"></i><b>0.7</b> <strong>Interpretations</strong></a></li>
<li class="chapter" data-level="0.8" data-path=""><a href="#conclusion"><i class="fa fa-check"></i><b>0.8</b> <strong>Conclusion</strong></a><ul>
<li class="chapter" data-level="0.8.1" data-path=""><a href="#sources"><i class="fa fa-check"></i><b>0.8.1</b> <strong>Sources:</strong></a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Linear regression: Modeling and Assumptions</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="header">
<h1 class="title">Linear regression: Modeling and Assumptions</h1>
<h4 class="author"><em>Kumar Rohit Malhotra</em></h4>
<h4 class="date"><em>2018-09-09</em></h4>
</div>
<p>Regression analysis is a powerful statistical process to find the relations within a dataset, with the key focus being on relationships between the independent variables (predictors) and a dependent variable (outcome). It can be used to build models for inference or prediction. Among several methods of regression analysis, linear regression sets the basis and is quite widely used for <a href="https://en.wikipedia.org/wiki/Linear_regression#Applications" target="_blank">several real-world applications</a>.</p>
<p>In this post, we will look at building a linear regression model for inference. The dataset we will use is the insurance charges data obtained from <a href="https://www.kaggle.com/mirichoi0218/insurance/home" target="_blank">Kaggle</a>. This data set consists of 1,338 observations and 7 columns: age, sex, bmi, children, smoker, region and charges.</p>
<p>The key questions that we would be asking are:</p>
<ol style="list-style-type: decimal">
<li>Is there a relationship between medical charges and other variables in the dataset?</li>
<li>How valid is the model we have built?</li>
<li>What can we do to improve the model?</li>
</ol>
<div class="figure">
<img src="/post/2018-09-05-linear-regression-modeling-and-assumptions_files/2120406.jpg" alt="Source : Google Images" width="350" height="350" />
<p class="caption">Source : Google Images</p>
</div>
<p>We start with importing the main required libraries and data:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(magrittr)
<span class="kw">library</span>(car)
<span class="kw">library</span>(broom)
<span class="kw">library</span>(ggplot2)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">insurance &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">&#39;~/Documents/CodeWork/medicalCost/insurance.csv&#39;</span>)
<span class="kw">summary</span>(insurance)</code></pre></div>
<pre><code>      age            sex           bmi           children     smoker    
 Min.   :18.00   female:662   Min.   :15.96   Min.   :0.000   no :1064  
 1st Qu.:27.00   male  :676   1st Qu.:26.30   1st Qu.:0.000   yes: 274  
 Median :39.00                Median :30.40   Median :1.000             
 Mean   :39.21                Mean   :30.66   Mean   :1.095             
 3rd Qu.:51.00                3rd Qu.:34.69   3rd Qu.:2.000             
 Max.   :64.00                Max.   :53.13   Max.   :5.000             
       region       charges     
 northeast:324   Min.   : 1122  
 northwest:325   1st Qu.: 4740  
 southeast:364   Median : 9382  
 southwest:325   Mean   :13270  
                 3rd Qu.:16640  
                 Max.   :63770  </code></pre>
<p>Some simple observations that can be taken from the summary are:</p>
<ol style="list-style-type: decimal">
<li>The age of participants varies from 18 to 64.</li>
<li>Around 49.48% of participants are female.</li>
<li>The bmi of participants ranges from 15.96 to 53.13.</li>
<li>Only 20.48% of the participants are smokers.</li>
</ol>
<p>Let’s start with building a linear model. Instead of simple linear regression, where you have one predictor and one outcome, we will go with multiple linear regression, where you have more than one predictors and one outcome.</p>
<p>Multiple linear regression follows the formula :</p>
<p><span class="math inline">\(y = {\beta_0}+ {\beta_1}x_1+{\beta_2}x_2+...\)</span></p>
<p>The coefficients in this linear equation denote the magnitude of additive relation between the predictor and the response. In simpler words, keeping everything else fixed, a unit change in <span class="math inline">\(x_1\)</span> will lead to change of <span class="math inline">\({\beta_1}\)</span> in the outcome, and so on.</p>
<div id="is-there-a-relationship-between-the-medical-charges-and-the-predictors" class="section level2">
<h2><span class="header-section-number">0.1</span> <strong>Is there a relationship between the medical charges and the predictors?</strong></h2>
<p>Our first step is finding if there is any relationship between the outcome and the predictors.</p>
<p>The null hypothesis would be that there is no relation between any of the predictors and the response, which can be tested by computing the <a href="http://www.statisticshowto.com/probability-and-statistics/F%20statistic-value-test/" target="_blank">F statistic</a>. The p-value of F statistic can be used to determine whether the null hypothesis can be rejected or not.</p>
<p>We will start with fitting a multiple linear regression model using all the predictors:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">lm.fit &lt;-<span class="st"> </span><span class="kw">lm</span>(<span class="dt">formula =</span> charges<span class="op">~</span>., <span class="dt">data =</span> insurance)
<span class="co">#Here &#39;.&#39; means we are using all the predictors in the dataset.</span>
<span class="kw">summary</span>(lm.fit)</code></pre></div>
<pre><code>
Call:
lm(formula = charges ~ ., data = insurance)

Residuals:
     Min       1Q   Median       3Q      Max 
-11304.9  -2848.1   -982.1   1393.9  29992.8 

Coefficients:
                Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)     -11938.5      987.8 -12.086  &lt; 2e-16 ***
age                256.9       11.9  21.587  &lt; 2e-16 ***
sexmale           -131.3      332.9  -0.394 0.693348    
bmi                339.2       28.6  11.860  &lt; 2e-16 ***
children           475.5      137.8   3.451 0.000577 ***
smokeryes        23848.5      413.1  57.723  &lt; 2e-16 ***
regionnorthwest   -353.0      476.3  -0.741 0.458769    
regionsoutheast  -1035.0      478.7  -2.162 0.030782 *  
regionsouthwest   -960.0      477.9  -2.009 0.044765 *  
---
Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1

Residual standard error: 6062 on 1329 degrees of freedom
Multiple R-squared:  0.7509,    Adjusted R-squared:  0.7494 
F-statistic: 500.8 on 8 and 1329 DF,  p-value: &lt; 2.2e-16</code></pre>
<p>A high value of F statistic, with a very low p-value (&lt;2.2e-16), implies that the null hypothesis can be rejected. This means there is a potential relationship between the predictors and the outcome.</p>
<p>RSE (Residual Standard Error) is the estimate of the standard deviation of irreducible error (the error which can’t be reduced even if knew the true regression line; hence, irreducible). In simpler words, it is the average deviation between the actual outcome and the true regression line. A large value of RSE (6062) means a high deviation of our model from the true regression line.</p>
<p>R-squared (<span class="math inline">\(R^2\)</span>) measures the proportion of variability in the outcome that can be explained by the model, and is always between 0 and 1; the higher the value, the better the model is able to explain the variability in the outcome. However, increase in number of predictors mostly results in an increased value of <span class="math inline">\(R^2\)</span> due to <a href="https://en.wikipedia.org/wiki/Coefficient_of_determination#Inflation_of_R2" target="_blank">inflation of R-squared</a>. <a href="https://en.wikipedia.org/wiki/Coefficient_of_determination#Adjusted_R2" target="_blank">Adjusted R-squared</a> adjusts the value of <span class="math inline">\(R^2\)</span> to avoid this effect. A high value of adjusted <span class="math inline">\(R^2\)</span> (0.7494) shows that more than 74% of the variance in the data is being explained by the model.</p>
<p>The Std. Error gives us the average amount that the estimated coefficient of a predictor differs from the actual coefficient of predictor. It can be used to compute the confidence interval of an estimated coefficient, which we will see later.</p>
<p>The <em>t value</em> of a predictor tells us how many standard deviations its estimated coefficient is away from 0. <em>Pr (&gt;|t|)</em> for a predictor is the p-value for the estimated regression coefficient, which is same as saying what is the probability of seeing a t value for the regression coefficient. A very low p-value (&lt;0.05) for a predictor can be used to infer that there is a relationsip between the predictor and the outcome.</p>
<p>Our next step should be <a href="https://en.wikipedia.org/wiki/Regression_validation" target="_blank">validation of regression analyis</a>. This may mean validation of underlying assumptions of the model, checking the structure of model with different predictors, looking for observations that have not been represented well enough in the model, and more. We will look at a few of these methods and assumptions.</p>
<hr />
</div>
<div id="which-variables-have-a-strong-relation-to-medical-charges" class="section level2">
<h2><span class="header-section-number">0.2</span> <strong>Which variables have a strong relation to medical charges?</strong></h2>
<p>Now that we have determined that there is a relation between the predictors and the outcome, our next step would be finding out if all or only some of the predictors are related to the outcome.</p>
<p>If we look at the p-values of the estimated coefficients above, we see that not all the coefficients are statistically significant (&lt;0.05). This means that only a subset of the predictors are related to the outcome.</p>
<p>We can look at the individual p-values for selecting the variables. This may not be a problem when the number of predictors (7) is quite small compared to the number of observations (1338). This method won’t, however, work when the number of predictors is greater than the number of observations because of the <a href="http://www.statisticshowto.com/multiple-testing-problem/" target="_blank">multiple testing problem</a>. A better way of selecting predictors is <a href="https://en.wikipedia.org/wiki/Feature_selection" target="_blank">feature/variable selection</a> methods, like forward selection, backward selection, or mixed selection.</p>
<p>Before jumping on to feature selection using any of these methods, let us try linear regression using the features with significant p-values only.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">lm.fit.sel &lt;-<span class="st"> </span><span class="kw">lm</span>(charges<span class="op">~</span>age<span class="op">+</span>bmi<span class="op">+</span>children<span class="op">+</span>smoker<span class="op">+</span>region, <span class="dt">data =</span> insurance)</code></pre></div>
<p>We will compare this to <a href="https://www.stat.ubc.ca/~rollin/teach/643w04/lec/node43.html" target="_blank">mixed selection</a>, which is a combination of forward and backward selection. This can be done in R using the <em>stepAIC()</em> function, which uses <a href="https://en.wikipedia.org/wiki/Akaike_information_criterion" target="_blank">Akaike Information Criterion</a> (AIC) to select the best model out of multiple models.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#selecting direction = &quot;both&quot; for mixed selection</span>
step.lm.fit &lt;-<span class="st"> </span>MASS<span class="op">::</span><span class="kw">stepAIC</span>(lm.fit, <span class="dt">direction =</span> <span class="st">&quot;both&quot;</span>, <span class="dt">trace =</span> <span class="ot">FALSE</span>)</code></pre></div>
<p>Let’s compare the two models :</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">step.lm.fit<span class="op">$</span>call</code></pre></div>
<pre><code>lm(formula = charges ~ age + bmi + children + smoker + region, 
    data = insurance)</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">lm.fit.sel<span class="op">$</span>call</code></pre></div>
<pre><code>lm(formula = charges ~ age + bmi + children + smoker + region, 
    data = insurance)</code></pre>
<p>The model given by stepwise selection is same as the model we got by selecting the predictors with significant p-values (works in this case).</p>
<hr />
</div>
<div id="are-there-any-multicollinear-features" class="section level2">
<h2><span class="header-section-number">0.3</span> <strong>Are there any multicollinear features?</strong></h2>
<p>Multicollinearity in multiple regression is a phenomenon in which two or more predictors are highly related to each other, and hence one predictor can be used to predict the value of the other. The problem with multi-collinearity is that it can make it harder to estimate the individual effects of the predictors on the outcome.</p>
<p>Multicollinearity can be detected using the Variance Inflation Factor (VIF). VIF of any predictor is the ratio of variance of its estimated coefficient in the full model to the variance of its estimated coefficient when fit on the outcome only by itself (as in simple linear regression). A VIF of 1 indicates no presence of multicollinearity. Usually, a VIF value of above 5 or 10 is taken as an indicator of multicollinearity. The simplest way of getting rid of multicollinearity in that case is to discard the predictor with high value of VIF.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">vif</span>(step.lm.fit) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span>knitr<span class="op">::</span><span class="kw">kable</span>()</code></pre></div>
<table>
<thead>
<tr class="header">
<th></th>
<th align="right">GVIF</th>
<th align="right">Df</th>
<th align="right">GVIF^(1/(2*Df))</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>age</td>
<td align="right">1.016188</td>
<td align="right">1</td>
<td align="right">1.008061</td>
</tr>
<tr class="even">
<td>bmi</td>
<td align="right">1.104197</td>
<td align="right">1</td>
<td align="right">1.050808</td>
</tr>
<tr class="odd">
<td>children</td>
<td align="right">1.003714</td>
<td align="right">1</td>
<td align="right">1.001855</td>
</tr>
<tr class="even">
<td>smoker</td>
<td align="right">1.006369</td>
<td align="right">1</td>
<td align="right">1.003179</td>
</tr>
<tr class="odd">
<td>region</td>
<td align="right">1.098869</td>
<td align="right">3</td>
<td align="right">1.015838</td>
</tr>
</tbody>
</table>
<p>None of the predictors in our case has a high value of VIF. Hence, we don’t need to worry about multicollinearity in our case.</p>
<div class="figure">
<img src="/post/2018-09-05-linear-regression-modeling-and-assumptions_files/multicollinearity%20meme.jpg" alt="Source: Google Images" width="350" height="350" />
<p class="caption">Source: Google Images</p>
</div>
<hr />
</div>
<div id="is-the-relationship-linear" class="section level2">
<h2><span class="header-section-number">0.4</span> <strong>Is the relationship linear?</strong></h2>
<p>By applying linear regression, we are assuming that there is a linear relationship between the predictors and the outcome. If the underlying relationship is quite far from linear, then most of the inferences we would make would be doubtful.</p>
<p>The non-linearity of the model can be determined using the residual plot of fitted values versus the residuals. <a href="http://www.statisticshowto.com/residual/" target="_blank">Residual</a> for any observation is the difference between the actual outcome and the fitted outcome as per the model. Presence of a pattern in the residual plot would imply a problem with the linear assumption of the model.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#type = &quot;rstandard&quot; draws a plot for standardized residuals</span>
<span class="kw">residualPlot</span>(step.lm.fit, <span class="dt">type =</span> <span class="st">&quot;rstandard&quot;</span>)</code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-79-1.png" width="672" /></p>
<p>The blue line represents a smooth pattern between the fitted values and the standard residuals. The curve in our case denotes slight non-linearity in our data.</p>
<p>The non-linearity can be further explored by looking at <a href="https://www.r-bloggers.com/r-regression-diagnostics-part-1/" target="_blank">Component Residual plots</a> (CR plots).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ceresPlots</span>(step.lm.fit)</code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-80-1.png" width="672" /></p>
<p>The pink line (residual line) is modelled for the relation between the predictor and the residuals. The blue dashed line (component line) is for the line of best fit. A significant difference between the two lines for a predictor implies that the predictor and the outcome don’t have a linear relationship.</p>
<p>This kind of inconsistency can be seen in the CR plot for <em>bmi</em>. One of the methods of fixing this is introducing non-linear transformation of predictors of the model. Let’s try adding a non-linear transformation of <em>bmi</em> to the model.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#update() can be used to update an existing model with new requirements</span>
step.lm.fit.new &lt;-<span class="st"> </span><span class="kw">update</span>(step.lm.fit, .<span class="op">~</span>.<span class="op">+</span><span class="kw">I</span>(bmi<span class="op">^</span><span class="fl">1.25</span>))

<span class="kw">ceresPlots</span>(step.lm.fit.new)</code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-81-1.png" width="672" /></p>
<p>The CR plot of bmi no more has a difference between the residual line and the component line.</p>
<p>We can use ANOVA to check if the new model is significantly better than the previous model. A low p-value (&lt;0.05) for the new model will mean we can conclude that it is better than the previous model:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">anova</span>(step.lm.fit, step.lm.fit.new, <span class="dt">test =</span> <span class="st">&quot;F&quot;</span>)</code></pre></div>
<pre><code>Analysis of Variance Table

Model 1: charges ~ age + bmi + children + smoker + region
Model 2: charges ~ age + bmi + children + smoker + region + I(bmi^1.25)
  Res.Df        RSS Df Sum of Sq      F  Pr(&gt;F)  
1   1330 4.8845e+10                              
2   1329 4.8697e+10  1 148484981 4.0524 0.04431 *
---
Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
<p>Since the model with non-linear transformation of <em>bmi</em> has a sufficiently low p-value (&lt;0.05), we can conclude that it is better than the previous model, although the p-value is marginally.</p>
<p>Let’s look at the residual plot of this new model.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">residualPlot</span>(step.lm.fit.new, <span class="dt">type =</span> <span class="st">&quot;rstandard&quot;</span>)</code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-83-1.png" width="672" /></p>
<p>Looking at the residual plot of the new model, there is not much change in the overall pattern of the standard residuals.</p>
<div class="figure">
<img src="/post/2018-09-05-linear-regression-modeling-and-assumptions_files/multiple-regression-more-like-multiple-depression.jpg" alt="Source: Google Images" width="350" height="350" />
<p class="caption">Source: Google Images</p>
</div>
<p>Another method of fixing the problem of non-linearity is introducing an <a href="https://en.wikipedia.org/wiki/Interaction_(statistics)#In_regression" target="_blank">interaction</a> between some predictors. A person who smokes and has a high bmi may have higher charges as compared to a person who has lower bmi and is a non-smoker. Let’s update the model to introduce an interaction between <em>bmi</em> and <em>smoker</em>, and see if that makes a difference:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">lm.fit1 &lt;-<span class="st"> </span><span class="kw">update</span>(step.lm.fit.new, <span class="op">~</span><span class="st"> </span>.<span class="op">+</span>bmi<span class="op">*</span>smoker)

<span class="kw">residualPlot</span>(lm.fit1, <span class="dt">type =</span> <span class="st">&quot;rstandard&quot;</span>, <span class="dt">id=</span><span class="ot">TRUE</span>)</code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-84-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">anova</span>(step.lm.fit.new, lm.fit1, <span class="dt">test =</span> <span class="st">&quot;F&quot;</span>)</code></pre></div>
<pre><code>Analysis of Variance Table

Model 1: charges ~ age + bmi + children + smoker + region + I(bmi^1.25)
Model 2: charges ~ age + bmi + children + smoker + region + I(bmi^1.25) + 
    bmi:smoker
  Res.Df        RSS Df  Sum of Sq      F    Pr(&gt;F)    
1   1329 4.8697e+10                                   
2   1328 3.1069e+10  1 1.7627e+10 753.45 &lt; 2.2e-16 ***
---
Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
<p>Not only the relation becomes more linear with less appearance of a pattern in the residual plot, the new model is significantly better than the previous model (without interactions) as can be seen with the p-value (&lt;2.2e-16).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#checking the value of adjusted r-squared of new model</span>
<span class="kw">summary</span>(lm.fit1)<span class="op">$</span>adj.r.squared</code></pre></div>
<pre><code>[1] 0.840469</code></pre>
<p>The <span class="math inline">\(R^2\)</span> value of the model has also increased to more than 0.84.</p>
<hr />
</div>
<div id="non-constant-variance-of-error-terms" class="section level2">
<h2><span class="header-section-number">0.5</span> <strong>Non-constant variance of error terms</strong></h2>
<p>Constant variance (<a href="https://en.wikipedia.org/wiki/Homoscedasticity" target="_blank">homoscedasticity</a>) of errors is another assumption of a linear regression model. The error terms may, for instance, change with the value of the response variable in case of non-constant variance (heteroscedasticity) of errors. Some of the graphical methods of identifying heteroscedasticity is presence of a funnel shape in the residual plot, or existence of a curve in the residual plot. In the above plot, we don’t see any clear pattern.</p>
<p>A statistical way is an extension of the Breusch-Pagan Test, available in R as <em>ncvTest()</em> in the cars package. It assumes a null hypothesis of constant variance of errors against the alternate hypothesis that the error variance changes with the level of the response or with a linear combination of predictors.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># non-constant error variance test</span>
<span class="kw">ncvTest</span>(lm.fit1)</code></pre></div>
<pre><code>Non-constant Variance Score Test 
Variance formula: ~ fitted.values 
Chisquare = 17.90486, Df = 1, p = 2.3223e-05</code></pre>
<p>A very low p-value (~<span class="math inline">\(2.3*10^{-5}\)</span>) means the null hypothesis can be rejected. In other words, there is a high chance that the errors have a non-constant variance.</p>
<p>One of the methods to fix this problem is transformation of the outcome variable.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">yTransformer &lt;-<span class="st"> </span><span class="fl">0.8</span>
trans.lm.fit &lt;-<span class="st"> </span><span class="kw">update</span>(lm.fit1, charges<span class="op">^</span>yTransformer<span class="op">~</span>.)

<span class="co"># non-constant error variance test</span>
<span class="kw">ncvTest</span>(trans.lm.fit)</code></pre></div>
<pre><code>Non-constant Variance Score Test 
Variance formula: ~ fitted.values 
Chisquare = 0.005724708, Df = 1, p = 0.93969</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">residualPlot</span>(trans.lm.fit, <span class="dt">type =</span> <span class="st">&quot;rstandard&quot;</span>, <span class="dt">id=</span>T)</code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-87-1.png" width="672" /></p>
<p>A p-value of ~0.94 implies here that we cannot reject the null hypothesis of constant variance of error terms. However, there is a slight increase in non-linearity of the model as can be seen in the residual plot. This can be fixed further by looking at relations between individual predictors and outcome.</p>
<hr />
</div>
<div id="correlation-of-error-terms" class="section level2">
<h2><span class="header-section-number">0.6</span> <strong>Correlation of error terms</strong></h2>
<p>An important assumption of linear regression model is that the consecutive error terms are uncorrelated. The standard errors of the estimated regression coefficients are calculated on the basis of this assumption. If the consecutive error terms are correlated, the standard errors of the estimated regression coefficients may be much larger.</p>
<p>We can check the auto-correlation of error terms using the <a href="https://en.wikipedia.org/wiki/Durbin–Watson_statistic" target="_blank">Durbin-Watson test</a>. The null hypothesis is that the consecutive errors have no auto-correlation.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">1</span>)
<span class="co"># Test for Autocorrelated Errors</span>
<span class="kw">durbinWatsonTest</span>(trans.lm.fit, <span class="dt">max.lag =</span> <span class="dv">5</span>, <span class="dt">reps=</span><span class="dv">1000</span>)</code></pre></div>
<pre><code> lag Autocorrelation D-W Statistic p-value
   1    -0.036139510      2.070557   0.216
   2    -0.026396886      2.050927   0.340
   3    -0.009537725      2.017017   0.712
   4    -0.004187672      1.996569   0.972
   5     0.008894177      1.970058   0.680
 Alternative hypothesis: rho[lag] != 0</code></pre>
<p>The p-value for none of the 5 lags is less than 0.05. Hence, we cannot reject the null hypothesis that the consecutive errors are not correlated, concluding that the consecutive errors are independent of each other.</p>
<hr />
</div>
<div id="interpretations" class="section level2">
<h2><span class="header-section-number">0.7</span> <strong>Interpretations</strong></h2>
<p>Let’s look at the actual charges vs fitted values for the final model and compare it with the results from the initial model:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#function to plot fitted values vs actual values of charges</span>
fitted_vs_actual &lt;-<span class="st"> </span><span class="cf">function</span>(predictions, title){
  <span class="kw">ggplot</span>(predictions, <span class="kw">aes</span>(<span class="dt">x=</span>insurance<span class="op">$</span>charges, <span class="dt">y=</span>fit))<span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>()<span class="op">+</span>
<span class="st">  </span><span class="kw">geom_smooth</span>(<span class="kw">aes</span>(<span class="dt">color =</span> <span class="st">&#39;model&#39;</span>))<span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">x=</span><span class="kw">seq</span>(<span class="kw">min</span>(insurance<span class="op">$</span>charges),<span class="kw">max</span>(insurance<span class="op">$</span>charges), <span class="dt">length.out =</span> <span class="dv">1338</span>), 
                <span class="dt">y=</span><span class="kw">seq</span>(<span class="kw">min</span>(insurance<span class="op">$</span>charges),<span class="kw">max</span>(insurance<span class="op">$</span>charges), <span class="dt">length.out =</span> <span class="dv">1338</span>), 
                <span class="dt">color =</span> <span class="st">&#39;ideal&#39;</span>))<span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x=</span><span class="st">&quot;actual charges&quot;</span>, <span class="dt">y=</span><span class="st">&quot;fitted values&quot;</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">scale_color_manual</span>(<span class="st">&#39;linear relation&#39;</span>, <span class="dt">values =</span> <span class="kw">c</span>(<span class="st">&#39;red&#39;</span>, <span class="st">&#39;blue&#39;</span>)) <span class="op">+</span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="kw">c</span>(<span class="fl">0.1</span>, <span class="fl">0.8</span>))<span class="op">+</span>
<span class="st">    </span><span class="kw">ggtitle</span>(title)
}

<span class="co">#fitted values of initial model</span>
fitted_init &lt;-<span class="st"> </span><span class="kw">predict</span>(lm.fit, insurance, <span class="dt">interval =</span> <span class="st">&quot;confidence&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">tidy</span>()
g1 &lt;-<span class="st"> </span><span class="kw">fitted_vs_actual</span>(fitted_init, <span class="st">&quot;Initial Model&quot;</span>)

<span class="co">#fitted values of final model</span>
fitted_final &lt;-<span class="st"> </span><span class="kw">predict</span>(trans.lm.fit, insurance, 
                             <span class="dt">interval =</span> <span class="st">&quot;confidence&quot;</span>)<span class="op">^</span>(<span class="dv">1</span><span class="op">/</span>yTransformer) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">tidy</span>()
g2 &lt;-<span class="st"> </span><span class="kw">fitted_vs_actual</span>(fitted_final, <span class="st">&quot;Final Model&quot;</span>)

<span class="co">#creating the two plots side-by-side</span>
gridExtra<span class="op">::</span><span class="kw">grid.arrange</span>(g1,g2, <span class="dt">ncol =</span> <span class="dv">2</span>)</code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-89-1.png" width="672" /></p>
<p>The initial model is able to approximate the actual charges below 17,000 USD, but as the actual charges go above 20,000 USD, the gap between actual charges and fitted values keeps increasing. As per the initial model, the actual charges near 50,000 USD are fitted as somewhere near or below 40,000 USD, and this gap keeps increasing upwards.</p>
<p>In comparison, the fitted values in the new model are much closer to the actual charges, although there is still a lot of variation not explained by this model. It is still a major improvement from the initial model.</p>
<p>We can look at the estimated coefficients of the predictors and their confidence intervals for interpretation on how they define the model.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">confint</span>(trans.lm.fit) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">tidy</span>() <span class="op">%&gt;%</span>
<span class="st">  </span>tibble<span class="op">::</span><span class="kw">add_column</span>(<span class="dt">coefficients =</span> trans.lm.fit<span class="op">$</span>coefficients, <span class="dt">.after =</span> <span class="dv">2</span>) <span class="op">%&gt;%</span>
<span class="st">  </span>knitr<span class="op">::</span><span class="kw">kable</span>()</code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">.rownames</th>
<th align="right">X2.5..</th>
<th align="right">coefficients</th>
<th align="right">X97.5..</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">(Intercept)</td>
<td align="right">-2390.28154</td>
<td align="right">-1481.25919</td>
<td align="right">-572.236841</td>
</tr>
<tr class="even">
<td align="left">age</td>
<td align="right">31.55889</td>
<td align="right">33.69202</td>
<td align="right">35.825159</td>
</tr>
<tr class="odd">
<td align="left">bmi</td>
<td align="right">88.38395</td>
<td align="right">236.34998</td>
<td align="right">384.316015</td>
</tr>
<tr class="even">
<td align="left">children</td>
<td align="right">46.47332</td>
<td align="right">71.13811</td>
<td align="right">95.802903</td>
</tr>
<tr class="odd">
<td align="left">smokeryes</td>
<td align="right">-2132.65819</td>
<td align="right">-1763.80972</td>
<td align="right">-1394.961241</td>
</tr>
<tr class="even">
<td align="left">regionnorthwest</td>
<td align="right">-167.70823</td>
<td align="right">-82.26111</td>
<td align="right">3.186011</td>
</tr>
<tr class="odd">
<td align="left">regionsoutheast</td>
<td align="right">-234.48716</td>
<td align="right">-148.75323</td>
<td align="right">-63.019309</td>
</tr>
<tr class="even">
<td align="left">regionsouthwest</td>
<td align="right">-243.32648</td>
<td align="right">-157.63822</td>
<td align="right">-71.949962</td>
</tr>
<tr class="odd">
<td align="left">I(bmi^1.25)</td>
<td align="right">-129.18844</td>
<td align="right">-79.06113</td>
<td align="right">-28.933829</td>
</tr>
<tr class="even">
<td align="left">bmi:smokeryes</td>
<td align="right">132.95041</td>
<td align="right">144.72423</td>
<td align="right">156.498040</td>
</tr>
</tbody>
</table>
<p>In the above table, the X2.5 and X97.5 mark the lower and upper bounds for the 95% confidence interval of the regression coefficients. These are calculated using the standard errors of the estimated coefficients. As an example, for <em>age</em>, the estimated coefficient is ~33.69 and the 95% confidence interval lies between ~31.56 and ~35.83. This means that as per the model, keeping everything else fixed, an increase in 1 year of age will result in an increase of 33.69 in the value of <span class="math inline">\(charges^{0.8}\)</span> (since we transformed the outcome). However, this is an estimate and hence there is a scope for variation. This variation is accounted for by the confidence interval, denoting that about 95% of the times, the change in the value of <span class="math inline">\(charges^{0.8}\)</span> will be between 31.56 and 35.83, keeping everything else fixed.</p>
<p>Let’s visualize these effects to get a better understanding of how the predictors are related to the outcome as per the model.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#funtion to get model effects on transformed outcome</span>
plot_effect &lt;-<span class="st"> </span><span class="cf">function</span>(interaction, xpredictor){
  <span class="co">#get effects for predictor</span>
  effs &lt;-<span class="st"> </span>effects<span class="op">::</span><span class="kw">effect</span>(interaction, <span class="dt">mod =</span> trans.lm.fit, 
                 <span class="dt">xlevels =</span> <span class="kw">list</span>(<span class="dt">xpredictor=</span><span class="kw">min</span>(insurance[xpredictor])<span class="op">:</span><span class="kw">max</span>(insurance[xpredictor])))
  
  model.effs &lt;-<span class="st"> </span>effs[<span class="kw">c</span>(<span class="st">&#39;x&#39;</span>, <span class="st">&#39;lower&#39;</span>, <span class="st">&#39;fit&#39;</span>, <span class="st">&#39;upper&#39;</span>)] <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">as.data.frame</span>()
  
  model.effs<span class="op">$</span>fit &lt;-<span class="st"> </span>model.effs<span class="op">$</span>fit<span class="op">^</span>(<span class="dv">1</span><span class="op">/</span>yTransformer)
  model.effs<span class="op">$</span>lower &lt;-<span class="st"> </span>model.effs<span class="op">$</span>lower<span class="op">^</span>(<span class="dv">1</span><span class="op">/</span>yTransformer)
  model.effs<span class="op">$</span>upper &lt;-<span class="st"> </span>model.effs<span class="op">$</span>upper<span class="op">^</span>(<span class="dv">1</span><span class="op">/</span>yTransformer)
  
  <span class="kw">return</span>(model.effs)
}</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot_effect</span>(<span class="st">&#39;age&#39;</span>, <span class="st">&#39;age&#39;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> age, <span class="dt">y =</span> fit)) <span class="op">+</span>
<span class="st">  </span><span class="kw">theme_bw</span>()<span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>()<span class="op">+</span>
<span class="st">  </span><span class="kw">geom_ribbon</span>(<span class="kw">aes</span>(<span class="dt">ymin =</span> lower, <span class="dt">ymax =</span> upper), <span class="dt">alpha =</span> <span class="fl">0.5</span>)</code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-92-1.png" width="672" /></p>
<p>For an average value of other predictors, insurance charges increase with increase in age. More interesting effects can be seen for the interaction between <em>bmi</em> and <em>smoker</em>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot_effect</span>(<span class="st">&#39;bmi*smoker&#39;</span>, <span class="st">&#39;bmi&#39;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> x.bmi, <span class="dt">y =</span> fit)) <span class="op">+</span>
<span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>x.smoker)<span class="op">+</span>
<span class="st">  </span><span class="kw">theme_bw</span>()<span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>()<span class="op">+</span>
<span class="st">  </span><span class="kw">geom_ribbon</span>(<span class="kw">aes</span>(<span class="dt">ymin =</span> lower, <span class="dt">ymax =</span> upper), <span class="dt">alpha =</span> <span class="fl">0.5</span>)</code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-93-1.png" width="672" /></p>
<p>Non-smokers, irrespective of their bmi, have mostly low insurance charges for an average value of other predictors. Smokers with low bmi have low insurance charges, though still higher than non-smokers with any value of bmi. Moreover, as their bmi increases, the insurance charges of smokers increases rapidly.</p>
<hr />
</div>
<div id="conclusion" class="section level2">
<h2><span class="header-section-number">0.8</span> <strong>Conclusion</strong></h2>
<p>The model we have built can be used for inference of how the different predictors influence the outcome. It is far from perfect. Their is still presence of non-linearity and non-constant variance of errors. Moreover, the outliers and leverage points should be analyzed to find a better model. It may not (and most probably won’t) give similar results when used to predict the outcome for new, unseen data. In order to use it for prediction, more concrete measures should be taken for ensuring the accuracy of the model, like cross-validation. It still helps by providing good estimations of the significant relations between the predictors and the outcome. These estimations can be used to summarize the data in a more useful and presentful way.</p>
<hr />
<div id="sources" class="section level3">
<h3><span class="header-section-number">0.8.1</span> <strong>Sources:</strong></h3>
<ul>
<li>An Introduction to Statistical Learning and Reasoning</li>
<li>Wikipedia</li>
<li><a href="https://www.statmethods.net" target="_blank">Quick-R</a></li>
<li><a href="http://www.statisticshowto.com" target="_blank">Statistics How To</a></li>
</ul>

</div>
</div>
            </section>

          </div>
        </div>
      </div>


    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"linkedin": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "";
    if (src === "" || src === "true") src = "https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(src))
      src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
